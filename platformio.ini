; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[env:esp32dev]

platform = espressif32
board = esp32dev
framework = espidf
; setup build flags. 
; include the MP3 file
; include all include/ folders from all needed libs
; add the lib/ folder of the needed libraries to the search path
; select LYRAT_V4_3 as the board configuration (for GPIO pins)

; include everything but the source files for board we do not want.
src_filter = +<*> -<../lib/audio_hal/board/lyrat_v4_2/*> -<../lib/audio_hal/board/lyrat_v4_3/*> -<../lib/audio_hal/board/lyrat_v4_lyratd_msc_v2_1/*>
build_flags = 
	-D CONFIG_ESP_LYRATD_MSC_V2_2_BOARD
	-D CONFIG_SPIRAM_CACHE_WORKAROUND
	-mfix-esp32-psram-cache-issue
	-D CONFIG_SPIRAM_SUPPORT=1
	-D CONFIG_SPIRAM_BOOT_INIT
	-D CONFIG_SPIRAM_TYPE_AUTO=1
	-D CONFIG_SPIRAM_SIZE=-1
	-D CONFIG_SPIRAM_SPEED_40M
	-D CONFIG_SPIRAM_MEMTEST=1
	-D CONFIG_SPIRAM_MALLOC_RESERVE_INTERNAL=32768
	-D CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL=16384
	-D CONFIG_SPIRAM_USE_MALLOC=1
	-D CONFIG_SUPPORT_STATIC_ALLOCATION=1
	-D CONFIG_PICO_PSRAM_CS_IO=10
	-D CONFIG_SPIRAM_OCCUPY_VSPI_HOST
	-D COMPONENT_EMBED_TXTFILES=adf_music.mp3
	-I lib/audio_hal/include
	-I lib/audio_hal/board/include
	-I lib/audio_hal/board/lyratd_msc_v2_2
	-I lib/audio_hal/driver/es8374
	-I lib/audio_hal/driver/es8388
	-I lib/audio_hal/driver/zl38063
	-I lib/audio_hal/driver/zl38063/api_lib
	-I lib/audio_hal/driver/zl38063/example_apps
	-I lib/audio_hal/driver/zl38063/firmware
	-L lib/audio_hal/driver/zl38063/firmware
	-lfirmware
	-I lib/audio_pipeline/include
	-I lib/audio_sal/include
	-I lib/audio_stream/include
	-I lib/esp_codec/include
	-I lib/esp_codec/include/codec
	-I lib/esp_codec/include/processing
	-I lib/esp_codec/resample/include
	-I lib/esp_codec/wav/include
	-L lib/esp_codec/lib	
	-lesp_codec
	-I lib/esp_http_client/include
	-I lib/esp_http_client/lib/include
	-I lib/esp_peripherals/driver/i2c_bus
	-I lib/esp_peripherals/include
	-I lib/esp_peripherals/lib/adc_button
	-I lib/esp_peripherals/lib/blufi
	-I lib/esp_peripherals/lib/button
	-I lib/esp_peripherals/lib/IS31FL3216
	-I lib/esp_peripherals/lib/sdcard
	-I lib/esp_peripherals/lib/touch
  	-std=c++11

; tell the LDF to *not* use .a files for linking, but link the .o files in place
; this is necccessary because PIO generatates a "libesp_codec.a" file automatically,
; however, we also have another "libesp_codec.a" that we need to link -> name collision
lib_archive = false 
; un-include the ESP-IDFs native esp_http_client library
; actually we should just use an older ESP-IDF version, but then the 
; include for the binary file breaks.. 
; lib was added to ESP-IDF with https://github.com/espressif/esp-idf/commit/ff528d13c7a24f3b5cb7937a41f6e1d8a921a99c#diff-c7c711c57aa3482655dd39165cf29087
; ESP-ADF fixes ESP-IDF at the 3.0 release.
; but with this, we can built ESP-ADF with the latest stable ESP-IDF! :)
; UPDATE: Even with the newest ESP-IDF version we still need this lib because esp_http_client_set_redirection()
; is only found in the ESP-ADF version but in the ESP-IDF's version..

; this should have actually worked, but it doesn't...
;build_unflags = -I"$PIOHOME_DIR/packages/framework-espidf/components/esp_http_client/include"

; CHANGE THIS PATH TO THE PLATFORMIO HOME DIRECTORY. 
; On Windows: Only change username. (C:\Users\<user>\.platformio)
; On Linux / Mac standard: /home/<user>/.platformio
build_unflags = -I"C:/Users/Maxi/.platformio/packages/framework-espidf/components/esp_http_client/include" -std=gnu++11

; execute script which fixes multiple compilation errors which ESP-ADF is too lazy to fix right now.
extra_scripts =  compilation_fixer.py

; dependencies for this app
lib_deps = 
	audio_pipeline
	audio_hal
	audio_sal
	audio_stream
	esp_codec
	esp_http_client
	esp_peripherals